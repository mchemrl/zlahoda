<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Store Products</title>
</head>
<body>
    <h1>Store Products</h1>

    <button onclick="document.getElementById('ProductForm').style.display='block'">Додати продукт</button>
    <button onclick="document.getElementById('deleteProductForm').style.display='block'">Видалити продукт</button>
    <button onclick="document.getElementById('editProductForm').style.display='block'">Edit продукт</button>

    <p><a href = 'index.html'>back</a></p>

    <div id="ProductForm" style="display: none;">
        <h2>Додати новий продукт</h2>
        <form id="addProductForm">
            <label for="delete_product_name">Назва продукту:</label>
            <select id="product_name" name="product_name">
                <option value="" disabled selected>Оберіть продукт</option>
            </select><br><br>

            <label for="UPC">UPC:</label>
            <input type="text" id="UPC" name="UPC" maxlength="12"><br><br>

            <label for="selling_price">Ціна:</label>
            <input type="number" id="selling_price" name="selling_price"><br><br>

            <label for="products_number">Кількість:</label>
            <input type="number" id="products_number" name="products_number"><br><br>

            <label for="promotional_product">Акційний товар:</label>
            <input type="checkbox" id="promotional_product" name="promotional_product"><br><br>

            <button type="button" onclick="addProduct()">Додати</button>
            <button type="button" onclick="document.getElementById('addProductForm').style.display='none'">Закрити</button>
        </form>
    </div>

    <div id="deleteProductForm" style="display: none;">
        <h1>Delete a product</h1>
        <form>
            <label for="delete_product_name">Назва продукту:</label>
            <select id="delete_product_name" name="product_name">
                <option value="" disabled selected>Оберіть продукт</option>
            </select><br><br>
            <button type="button" onclick="deleteProduct()">Delete</button>
            <button type="button" onclick="document.getElementById('deleteProductForm').style.display='none'">Закрити</button>
        </form>
    </div>

    <div id="editProductForm" style="display: none;">
        <h2>Edit Product</h2>
        <form>
            <label for="edit_product_name">Назва продукту:</label>
            <select id="edit_product_name" name="product_name" onchange="fillEditForm()">
                <option value="" disabled selected>Оберіть продукт</option>
            </select><br><br>

            <label for="edit_UPC">UPC:</label>
            <input type="text" id="edit_UPC" name="UPC"><br><br>

            <label for="edit_selling_price">Ціна:</label>
            <input type="number" id="edit_selling_price" name="selling_price"><br><br>

            <label for="edit_products_count">Кількість:</label>
            <input type="number" id="edit_products_count" name="products_count"><br><br>

            <label for="edit_promotional_product">Акційний товар:</label>
            <input type="checkbox" id="edit_promotional_product" name="promotional_product"><br><br>

            <input type="hidden" id="original_UPC" name="original_UPC" value="">

            <button type="button" onclick="editProduct()">Save</button>
            <button type="button" onclick="document.getElementById('editProductForm').style.display='none'">Закрити</button>
        </form>
    </div>

    <h2>All Store Products (JSON)</h2>
    <pre id="jsonOutput"></pre>

    <script>
        let storeProductsData = [];

        function fetchProducts() {
            fetch("http://127.0.0.1:5000/get_products")
                .then(response => response.json())
                .then(data => {
                    console.log(data);

                    const productSelect = document.getElementById('product_name');
                    productSelect.innerHTML = '';
                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = 'Оберіть продукт';
                    productSelect.appendChild(defaultOption);

                    data.forEach(product => {
                        const option = document.createElement('option');
                        option.value = product.id;
                        console.log(option.value)
                        option.textContent = product.product_name;
                        productSelect.appendChild(option);
                    });

                    document.getElementById('jsonOutput').textContent = JSON.stringify(data, null, 2);
                })
                .catch(error => console.error('Error fetching products:', error));
        }

        function fetchStoreProducts() {
            fetch("http://127.0.0.1:5000/get_store_products")
                .then(response => response.json())
                .then(data => {
                    storeProductsData = data;

                    const selectIds = ['delete_product_name', 'edit_product_name'];
                    selectIds.forEach(selectId => {
                        const selectElement = document.getElementById(selectId);
                        if (!selectElement) return;

                        selectElement.innerHTML = '';
                        const defaultOption = document.createElement('option');
                        defaultOption.value = '';
                        defaultOption.disabled = true;
                        defaultOption.selected = true;
                        defaultOption.textContent = 'Оберіть продукт';
                        selectElement.appendChild(defaultOption);

                        data.forEach(product => {
                            const option = document.createElement('option');
                            option.value = product.UPC;
                            option.textContent = `${product.product_name} (UPC: ${product.UPC})`;
                            selectElement.appendChild(option);
                        });
                    });

                    document.getElementById('jsonOutput').textContent = JSON.stringify(data, null, 2);
                })
                .catch(error => console.error('Error fetching store products:', error));
        }

        function addProduct() {
            const idProduct = document.getElementById('product_name').value;
            const UPC = document.getElementById('UPC').value;
            const sellingPrice = document.getElementById('selling_price').value;
            const productsNumber = document.getElementById('products_number').value;
            const promotionalProduct = document.getElementById('promotional_product').checked;

            if (!idProduct) {
                alert('Please select a product.');
                return;
            }

            if (!UPC) {
                alert('Please enter a UPC code.');
                return;
            }

            if (!sellingPrice || !productsNumber) {
                alert('Please provide all product details.');
                return;
            }

            const productData = {
                id_product: idProduct,
                UPC: UPC,
                selling_price: sellingPrice,
                products_number: productsNumber,
                promotional_product: promotionalProduct
            };

            fetch('http://127.0.0.1:5000/add_store_product', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(productData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    alert('Product added successfully!');
                    fetchStoreProducts();
                } else {
                    alert('Error adding product: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }

       function deleteProduct() {
            const selectedUPC = document.getElementById('delete_product_name').value;

            if (!selectedUPC) {
                alert('Please select a product to delete.');
                return;
            }

            fetch(`http://127.0.0.1:5000/delete_store_product/${selectedUPC}`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    alert('Product deleted');
                    fetchStoreProducts();
                } else {
                    alert('Error deleting product: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Something went wrong while deleting the product.');
            });
        }


        function fillEditForm() {
            const selectedUPC = document.getElementById('edit_product_name').value;
            const product = storeProductsData.find(p => p.UPC === selectedUPC);

            if (product) {
                document.getElementById('edit_UPC').value = product.UPC;
                document.getElementById('original_UPC').value = product.UPC; // store the old UPC
                document.getElementById('edit_selling_price').value = product.selling_price;
                document.getElementById('edit_products_count').value = product.products_number;
                document.getElementById('edit_promotional_product').checked = product.promotional_product;
                document.getElementById('editProductForm').style.display = 'block';
            }
        }

        function editProduct() {
            const oldUPC = document.getElementById('original_UPC').value;
            const newUPC = document.getElementById('edit_UPC').value;
            const newPrice = document.getElementById('edit_selling_price').value;
            const newCount = document.getElementById('edit_products_count').value;
            const isPromotional = document.getElementById('edit_promotional_product').checked;

            if (!oldUPC) {
                alert("Something went wrong. Try selecting the product again.");
                return;
            }

            if (!newUPC || !newPrice || !newCount) {
                alert("Please fill in all required fields.");
                return;
            }

            const payload = {
                old_upc: oldUPC,
                new_upc: newUPC,
                selling_price: newPrice,
                products_number: newCount,
                promotional_product: isPromotional
            };
            console.log(payload);

            const id_product = document.getElementById('product_id').value;

            fetch(`http://127.0.0.1:5000/update_store_product/${id_product}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    alert("Product updated successfully!");
                    fetchStoreProducts();
                    document.getElementById('editProductForm').style.display = 'none';
                } else {
                    alert("Error updating product: " + data.error);
                }
            })
            .catch(error => {
                console.error("Error editing product:", error);
                alert("Something went wrong while updating the product.");
            });
        }

        window.onload = function() {
            fetchProducts();
            fetchStoreProducts();
        };
    </script>
</body>
</html>
